<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Contra Shooter</title>
    <script src="js/phaser.js"></script>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">


    var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update, render: render });
    var CANVAS_WIDTH = 800;
    var CANVAS_HEIGHT = 600;
    var MAX_ANIMAL_COUNT = 20;
    var MOVE_SPEED = 2;
    var SPRITE_SIZE = 80;
    var SPRITE_HALF = 40;
    function preload() {

        game.load.tilemap('level1json', 'img/level1json.json', null, Phaser.Tilemap.TILED_JSON);
        game.load.image('tiles-1', 'img/tiles-1.png');
        game.load.spritesheet('dude', 'img/dude.png', 32, 48);
        game.load.spritesheet('enemy', 'img/dudeEnemy.png',32,48);
        game.load.spritesheet('enemyBomber','img/enemyBomber.png',32,48);
        game.load.spritesheet('droid', 'img/droid.png', 32, 32);
        game.load.image('starSmall', 'img/star.png');
        game.load.image('starBig', 'img/star2.png');
        game.load.image('background', 'img/background2.png');
        game.load.image('spriteBullet','img/spriteBulletG.png');
        game.load.image('spriteEnemyBullet', 'img/enemyBullet.png');
        game.load.image('dynamite','img/dynamite.png');
        game.time.advancedTiming = true;
        //comment test
    }

    var map,tileset,layer,player,animalFacing,cursors,jumpButton,bg,bullets,enemy,enemies,enemiesGroup,counter,baddieMover,enemyBullets;
    var facing = 'left';
    var jumpTimer = 0;
    var bulletTime = 0;

    function create() {

        //maps and collisions
        mapAndCollisions();

        //create bullets
        createBullets();
        createEnemyBullets();


        //  Un-comment this on to see the collision tilddes
        //layer.debug = true;

        layer.resizeWorld();

        //player animations and control mapping
        playerSettings();
        player.x = 308;
        player.y = 80;

       // enemy.body.collideWorldBounds = true;
        //enemy.body.gravity.y = 250;
        //enemy.body.velocity.x = 0;
        enemiesGroup = game.add.group();
        enemiesGroup.enableBody = true;
        enemiesGroup.physicsBodyType = Phaser.Physics.ARCADE;
        createSomeAnimals(12);


        //for(var i = 0; i < 1;i++){}

       // createSomeEnemies();

       // Enemy(1,game, 376, 150,player);
        //Enemy(2,game, 5,400,player);
    }
function createSomeAnimals(iHowMany){

    for(var i = 0; i < iHowMany;i++)
    {
        var x = game.rnd.integerInRange(0, CANVAS_WIDTH-80);
        var y = game.rnd.integerInRange(0, CANVAS_HEIGHT-80);
        var type = 0;
        var enemy = this.enemiesGroup.getFirstDead();
        if(enemy === null){
            enemy = new Enemy(game,x,y,type);
            this.enemiesGroup.add(enemy);
        }
        //animal.animations.add('myanimation', [ type, type+5, type+10, type+5], 8, true);
        //animal.play('myanimation', 5, true, false);
        enemy.body.setSize(20, 32, 5, 16);
        enemy.animations.add('left', [0, 1, 2, 3], 10, true);
        enemy.animations.add('turn', [4], 20, true);
        enemy.animations.add('right', [5, 6, 7, 8], 10, true);
        enemy.body.gravity.y = 250;
        Phaser.Math.snapTo(enemy.body.y, 70);
        enemy.revive();
        enemy.x = x;
        enemy.y = y;

        //animal.enableBody = true;
        enemy.frame = type;
        enemy.EnemyType = type;

    }
}
    var Enemy = function(pgame,x,y,enemytype){
        switch(enemytype)
        { case 0:Phaser.Sprite.call(this,pgame,x,y,'enemy'); break;
            case 1:Phaser.Sprite.call(this,pgame,x,y,'enemyBomber');break;}
        this.enemytype = enemytype;
        this.xspeed = 1;
        this.yspeed = 1;
        counter = this.game.rnd.between(0,100);
        this.animalFacing = null;
       // this.EnemyType = 0;
        this.frame = enemytype;
        pgame.physics.enable(this,Phaser.Physics.ARCADE);
        switch(this.enemytype) {
            case 0:
                game.time.events.loop(Phaser.Timer.SECOND * 3, enemyPatrol, this);
                game.time.events.loop(Phaser.Timer.SECOND * this.game.rnd.realInRange(1, 8), enemyFireBullet, this);
                break;
            case 1:
                break;

        }
        //this.game.rnd.realInRange(1,8)

    }
    Enemy.prototype = Object.create(Phaser.Sprite.prototype);
    Enemy.prototype.constructor = Enemy;

    // animal update move around
    Enemy.prototype.update = function() {
        if (this.alive) {

            // move animals around

            switch (this.enemytype ) {
                case 0: // not moving
                    // animalPatrol()


                    if (this.game.physics.arcade.distanceBetween(this, player) < 300)
                    {
                        if (this.body.y < player.body.y) {
                        // this.body.gravity.y = 5000;
                       }
                        if(this.body.onFloor()){ game.physics.arcade.moveToXY(this, player.body.x, player.body.y  , 100);}
                    }
                    //Phaser.Math.snapTo(enemy.body.x, 70) 3rd parameter of movetoxy
                    // game.physics.arcade.moveToObject(animal,player,70);
                    break;
                case 1:
                    break;

            }
        }
        ;
    }


        function enemyPatrol() {

            //counter +=1;
            baddieMover = game.rnd.integerInRange(1, 2);

            // simple if statement to choose if and which way the baddie moves
            if (this.body.x < 100 && baddieMover == 2) {
                baddieMover = 1;
            }

            if (baddieMover == 1) {
                this.body.velocity.x = 75;
                this.animations.play('right');
                this.animalFacing = 'right';

            }
            else if (baddieMover == 2) {
                this.body.velocity.x = -75;
                this.animations.play('left');
                this.animalFacing = 'left';
            }


        }


        function mapAndCollisions() {
            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.stage.backgroundColor = '#000000';
            bg = game.add.tileSprite(0, 0, 800, 600, 'background');
            bg.fixedToCamera = true;
            map = game.add.tilemap('level1json');
            map.addTilesetImage('tiles-1');
            map.setCollisionByExclusion([13, 14, 15, 16, 46, 47, 48, 49, 50, 51]);
            layer = map.createLayer('Tile Layer 1');
        }

        function playerSettings() {
            var left = game.input.keyboard.addKey(Phaser.Keyboard.A);


            player = game.add.sprite(32, 32, 'dude');
            game.physics.enable(player, Phaser.Physics.ARCADE);

            player.body.bounce.x = 1;
            player.body.collideWorldBounds = true;
            player.body.setSize(20, 32, 5, 16);

            player.animations.add('left', [0, 1, 2, 3], 10, true);
            player.animations.add('turn', [4], 20, true);
            player.animations.add('right', [5, 6, 7, 8], 10, true);

            game.camera.follow(player);
            //KEYMAPPING
            cursors = game.input.keyboard.createCursorKeys();
            jumpButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
            a = game.input.keyboard.addKey(Phaser.Keyboard.A);
            D = game.input.keyboard.addKey(Phaser.Keyboard.D);
            S = game.input.keyboard.addKey(Phaser.Keyboard.S);
        }

        function createEnemyBullets() {
            enemyBullets = game.add.group();
            enemyBullets.enableBody = true;
            enemyBullets.physicsBodyType = Phaser.Physics.ARCADE;
            enemyBullets.createMultiple(30, 'spriteEnemyBullet');
            enemyBullets.setAll('anchor.x', 0);
            enemyBullets.setAll('anchor.y', 0);
            enemyBullets.setAll('outOfBoundsKill', true);
            enemyBullets.setAll('checkWorldBounds', true);

        }

        function createBullets() {
            //Bullet!
            bullets = game.add.group();
            bullets.enableBody = true;
            bullets.physicsBodyType = Phaser.Physics.ARCADE;
            bullets.createMultiple(30, 'spriteBullet');

            bullets.setAll('anchor.x', 0);
            bullets.setAll('anchor.y', 0);
            bullets.setAll('outOfBoundsKill', true);
            bullets.setAll('checkWorldBounds', true);
        }

        function enemyFireBullet() {

            if (this.alive) {
                bulle = enemyBullets.getFirstExists(false);
                if (bulle) {
                    bulle.reset(this.body.x - 28, this.body.y + 0);
                    bulle.body.setSize(20, 20, 18, 16);
                    if (this.animalFacing == 'left') {
                        bulle.body.velocity.x = -100
                    }
                    else {
                        bulle.body.velocity.x = 100
                    }
                    // bulle.body.velocity.x = 100;
                    //  bulle.body.velocity.y = 0;
                    bulle.lifespan = 10000;
                }
            }

        }

        function fireBullet(facing) {
            var shotDirX = 0;
            var shotDirY = 0;
            var shootingDown = false;
            var isProne = false;
            if (game.time.now > bulletTime) {
                bullet = bullets.getFirstExists(false);

                if (bullet) {
                    if (cursors.right.isDown && cursors.up.isDown) {
                        shotDirX = 1000;
                        shotDirY = -250;
                    }
                    else if (cursors.right.isDown && S.isDown) {
                        shotDirX = 1000;
                        //shotDirY = 250;
                        isProne = true;
                    }
                    else if (cursors.right.isDown && cursors.down.isDown) {
                        shotDirX = 1000;
                        shotDirY = 250;
                        //shotDirY = this.game.rnd.between(-10,10);
                    }
                    else if (cursors.right.isDown) {
                        shotDirX = 1000;
                        //shotDirY = this.game.rnd.between(-10,10);
                    }
                    else if (cursors.left.isDown && cursors.up.isDown) {
                        shotDirX = -1000;
                        shotDirY = -250;
                    }
                    else if (cursors.left.isDown && cursors.down.isDown) {
                        shotDirX = -1000;
                        shotDirY = 250;
                    }
                    else if (cursors.left.isDown && S.isDown) {
                        shotDirX = -1000;
                        // shotDirY = 250;
                        isProne = true;
                    }
                    else if (cursors.left.isDown) {
                        shotDirX = -1000;
                    }
                    else if (cursors.up.isDown) {
                        shotDirY = -1000;
                    }
                    else if (cursors.down.isDown) {
                        shotDirY = 1000;
                        shootingDown = true;
                    }
                    if (isProne && player.body.onFloor()) {
                        bullet.reset(player.body.x - 28, player.body.y + 0);
                    }
                    else {
                        if (shootingDown == true) {
                            bullet.reset(player.body.x - 28, player.body.y + 0);
                        }
                        else {
                            bullet.reset(player.body.x - 28, player.body.y - 18);
                        }
                    }

                }

                bullet.lifespan = 20000;
                // bullet.rotation = player.rotation;
                // bullet.anchor.setTo(.5,.5);
                // game.physics.arcade.velocityFromRotation(player.rotation, 800, bullet.body.velocity);
                // this.physics.enable(this.bullet, Phaser.Physics.ARCADE);

                //SIZE CHECK// COLLISION BOX//
                this.bullet.body.setSize(20, 20, 18, 16);
                this.bullet.body.velocity.x = shotDirX;
                this.bullet.body.velocity.y = shotDirY;
                //this.bullet.body.velocity.x = 5;
                //this.bullet.body.velocity.y = 5;
                //bullet.body.rotation = 60;
                bulletTime = game.time.now + 100;
                //isProne = false;
            }
        }

        function playerControls() {
            if (cursors.right.isDown) {
                fireBullet(facing);
            }
            if (cursors.up.isDown) {
                fireBullet(facing);
            }
            if (cursors.left.isDown) {
                fireBullet(facing);
            }
            if (cursors.down.isDown) {
                fireBullet(facing);
            }
            if (a.isDown) {
                player.body.velocity.x = -150;

                if (facing != 'left') {
                    player.animations.play('left');
                    facing = 'left';
                }
            }
            else if (D.isDown) {
                player.body.velocity.x = 150;

                if (facing != 'right') {
                    player.animations.play('right');
                    facing = 'right';
                }
            }
            else {
                if (facing != 'idle') {
                    player.animations.stop();

                    if (facing == 'left') {
                        player.frame = 0;
                    }
                    else {
                        player.frame = 5;
                    }

                    facing = 'idle';
                }
            }
            //include in jump if statement......disabling for debug
            // && player.body.onFloor() in jumpButton selection
            if (jumpButton.isDown && game.time.now > jumpTimer) {
                player.body.velocity.y = -250;
                //jumpTimer = game.time.now + 750;
            }
        }

        var dir = 300;
        //var arr = [500,0,0,0];
        //var thing = game.rnd.integerInRange(0, 3);
        //var foo = arr[thing];
        //
        function thingy() {

        }

        function update() {

            game.physics.arcade.collide(player, layer);
            game.physics.arcade.collide(enemiesGroup, layer);
            game.physics.arcade.collide(enemiesGroup, enemiesGroup);
            game.physics.arcade.collide(player, enemiesGroup);
            game.physics.arcade.overlap(bullets, enemiesGroup, hitEnemy, null, this);
            game.physics.arcade.overlap(enemyBullets, player, hitPlayer, null, this);
            player.body.gravity.y = 250;
            player.body.velocity.x = 0;


            playerControls();


            //game.physics.arcade.moveToObject(enemy,player,70);

        }

        function hitPlayer(bullet, player) {

        }

        function hitEnemy(bullet, enemy) {
            bullet.kill();
            enemy.kill();
            enemy.alive = false;
        }

        // var pathCounter = 0;
        //overwrote to enemyPatrol for each enemy being alive

        function render() {

            //game.debug.text(game.time.physicsElapsed, 32, 32);
            game.debug.body(player, "#ff9090", false);
            //game.debug.inputInfo(32, 32);
//        FPS DEBUG
            game.debug.text(game.time.fps || '--', 2, 14, "#00ff00");
            enemiesGroup.forEachAlive(game.debug.body, game.debug, "#ff9090", false);
            bullets.forEachAlive(game.debug.body, game.debug, "#ff9090", false);
            enemyBullets.forEachAlive(game.debug.body, game.debug, "#ff9090", false);
            //game.debug.bodyInfo(animalsGroup, 16, 24);
            //game.debug.text(enemiesGroup.length,32,32);
            //this.game.debug.body(this.enemy);

        }



</script>

</body>
</html>