<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>HOT NIGGA</title>
        <script src="js/phaser.js"></script>
        <style>
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, 'towerdef', { preload: preload, create: create, update: update });

        var music;
        var time = 0;
        var player;
        var enemygroup;
        var towergroup;
        var typegroup;
        var bulletgroup;
        var text;
        var level;
        var testText;
        var bullet;
        var scale = 1.0;
        var timer = 0;

        function Path () {
            this.x = 0;
            this.y = 0;
        }

        function Level (layout) {
            this.layout = layout;
            this.path = generateWorld(layout);
        }

        function Enemy (sprite, health, type, path) {
            this.sprite = sprite;
            this.health = health;
            this.type = type;
            this.current = 1;
            this.path = path;
            this.waypoint = this.path[this.current];
            this.nextPath = function nextPath() {
                if(this.current < this.path.length-1) {
                    this.current++;
                    this.waypoint = this.path[this.current];
                }
                return this.path[this.current];
            }
            this.isAtWaypoint = function isAtWaypoint() {
                if(this.waypoint.y - 8 <= Math.round(this.sprite.y) && ((this.waypoint.x - Math.round(this.sprite.x)) < 20 && (this.waypoint.x - Math.round(this.sprite.x)) > -20) ) {
                    return true;
                } else {
                    return false;
                }
            }
        }

        function Type(name, bullet) {
            this.name = name;
            this.bullet = bullet;
        }

        function Bullet(image, velocity) {
            this.image = image;
            this.velocity = velocity;
        }

        function Tower (sprite, damage, type, firetimer) {
            this.sprite = sprite;
            this.damage = damage;
            this.type = type;
            this.bullet = type.bullet;
            this.firetimer = firetimer;
            this.fireAtTarget = function fireAtTarget(target) {
                var bullet = game.add.sprite(this.sprite.x*scale, this.sprite.y*scale, this.bullet.image);
                bullet.anchor.setTo(0.5, 0.5);
                bullet.outOfBoundsKill = true;
                bullet.checkWorldBounds = true;
                bullet.lifespan = 1000;
                bullet.events.onOutOfBounds.add(destroyBullet, this);
                game.physics.enable(bullet, Phaser.Physics.ARCADE);
                game.physics.arcade.moveToObject(bullet, target, this.bullet.velocity);
                bulletgroup.push(bullet);
            }
            this.fireAtClosest = function fireAtClosest() {
                var bullet = game.add.sprite(this.sprite.x*scale, this.sprite.y*scale, this.bullet.image);
                bullet.anchor.setTo(0.5, 0.5);
                game.physics.enable(bullet, Phaser.Physics.ARCADE);
                bullet.outOfBoundsKill = true;
                bullet.checkWorldBounds = true;
                bullet.lifespan = 1000;
                bullet.events.onOutOfBounds.add(destroyBullet, this);
                var target;
                var previous = 0;
                for (var i = 0; i < enemygroup.length; i++) {
                    var distance = game.physics.arcade.distanceBetween(bullet, enemygroup[i].sprite);
                    if(distance < previous || previous == 0) {
                        previous = distance;
                        target = enemygroup[i].sprite;
                    }
                }
                game.physics.arcade.moveToObject(bullet, target, this.bullet.velocity);
                bulletgroup.push(bullet);
            }
            game.time.events.loop(Phaser.Timer.SECOND, this.fireAtClosest, this);
        }

        function generateWorld (layout) {

            var path = [];
            path.push(new Path());
            var tempsprite;

            for(var y = 0; y<layout.length; y++) {
                for(var x = 0; x<layout[y].length; x++) {

                    if(layout[y][x] == 0) {
                        if( y==0 ) {
                            path[0].x = ((x*128)+64)*scale;
                            path[0].y = 0;
                        } else {
                            var temp = 0;
                            temp = new Path();
                            temp.x = ((x * 128) + 64) * scale;
                            temp.y = ((y * 128) + 64) * scale;
                            path.push(temp);
                        }

                        tempsprite = game.add.sprite((x * 128) * scale, (y * 128) * scale, 'path');
                        tempsprite.scale.x = scale;
                        tempsprite.scale.y = scale;

                    } else if(layout[y][x] == 1) {

                        tempsprite = game.add.sprite((x*128)*scale, (y*128)*scale, 'grass');
                        tempsprite.scale.x = scale;
                        tempsprite.scale.y = scale;

                    }
                }
            }
            return path;
        }

        function spawnEnemy (entrypoint) {
            var enemy = game.add.sprite(entrypoint.x + (game.rnd.integerInRange(0, 20) - game.rnd.integerInRange(0, 20)), entrypoint.y, 'enemy');
            enemy.anchor.setTo(0.5, 0.5);
            game.physics.enable(enemy, Phaser.Physics.ARCADE);
            return enemy;
        }

        function spawnTower () {
            var tower = game.add.sprite(game.input.mousePointer.x,game.input.mousePointer.y, 'player');
            tower.anchor.setTo(0.5, 0.5);
            game.physics.enable(tower, Phaser.Physics.ARCADE);
            return tower;
        }

        function destroyBullet(sprite) {
            sprite.destroy();
        }

        function preload () {

            game.load.image('enemy', 'img/enemy.png');
            game.load.image('path', 'img/path.png');
            game.load.image('grass', 'img/grass.png');
			game.load.image('player', 'img/player.png');
            game.load.image('bullet','img/bullet.png');
			game.load.audio('hotnigga', ['snd/htngg.mp3']);
			game.stage.backgroundColor = '#555555';

        }

        function create () {


			text = game.add.text(game.world.centerX, game.world.centerY, "Test", {
			    font: "12pt Arial",
			    fill: "#ff0044",
			    align: "center"
			});

            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.physics.arcade.setBounds(0, 0, game.width, game.height);

		    music = game.add.audio('hotnigga');
			//music.play();

            text = game.add.text(100, 100, '');

            var layout = [
                    [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                    [0,0,0,1,1,1,1,1,1,1,1,1,1,1,1],
                    [1,1,0,0,1,1,1,1,1,1,1,1,1,1,1],
                    [1,1,1,0,1,1,1,1,1,1,1,1,1,1,1],
                    [1,1,1,0,1,1,1,1,1,1,1,1,1,1,1],
                    [1,1,1,0,0,0,0,0,0,0,0,0,1,1,1],
                    [1,1,1,1,1,1,1,1,1,1,1,0,1,1,1],
                    [1,1,1,1,1,1,1,1,1,1,1,0,1,1,1]
            ];
            level = new Level(layout);

            enemygroup = [];
            towergroup = [];
            typegroup = [];
            bulletgroup = [];

            var bullet = new Bullet('bullet', 2000);
            typegroup.push(new Type('arrow', bullet));

            testText = game.add.text(32, 550, '0', { font: "20px Arial", fill: "#ffffff", align: "left" });
			//repeats spawning enemies(seconds,amount of times,function)
			game.time.events.loop(Phaser.Timer.SECOND * 2, enemyPlace, this, 5, "blackball", level.path);
        }
		//repeated function
		function enemyPlace(health, type, path){
            var enemy = new Enemy(spawnEnemy(level.path[0]), health, type, path);
            enemygroup.push(enemy);
		}

        function towerPlace(damage, type, firetimer) {
            var tower = new Tower(spawnTower(), damage, type, firetimer);
            towergroup.push(tower);
        }

        function isOverlapping(){

            for(var i = 0;i < towergroup.length;i++)
            {
                var tower = towergroup[i];
                var x = tower.sprite.x;
                var y = tower.sprite.y;
                if(x <= game.input.mousePointer.x + (64 * scale) && y <= game.input.mousePointer.y + (64 * scale) &&
                        x >= game.input.mousePointer.x - (64 * scale) && y >= game.input.mousePointer.y - (64 * scale))
                {
                    return true;

                }
            }
            return false;
        }

        function bulletHitsEnemy(i, x){
            enemygroup[i].sprite.destroy();
            enemygroup.splice(i,1);
            bulletgroup[x].sprite.destroy();
            bulletgroup.splice(i,1);
        }

		function update() {

            time += game.time.physicsElapsed;

            for (var i = 0; i < enemygroup.length; i++) {
                var enemy = enemygroup[i];
                if (enemy.isAtWaypoint()) {
                    var tempwaypoint = enemy.waypoint;
                    enemy.nextPath();
                }
                game.physics.arcade.moveToXY(enemy.sprite, enemy.waypoint.x, enemy.waypoint.y, 200);
                if(tempwaypoint == enemy.waypoint) {
                    enemy.sprite.destroy();
                    enemygroup.splice(i,1);
                }
            }

            if (game.input.activePointer.isDown) {
                if (isOverlapping() == false) {
                    towerPlace(1, typegroup[0], 1.0);
                }
            }

            /*for (var i = 0; i < enemygroup.length; i++) {
                for (var x = 0; x < bulletgroup.length; x++) {
                    var test = game.physics.arcade.overlap(enemygroup[i], bulletgroup[x], function (i, x) {
                        bulletHitsEnemy(i, x);
                    });
                    console.log(test);
                }
            }*/

            if (time > 2.100) {
                if (typeof towergroup !== "undefined" && typeof enemygroup !== "undefined") {
                    for (var i = 0; i < towergroup.length; i++) {
                        var tower = towergroup[i];
                        if(timer + tower.firetimer < time + tower.firetimer) {
                            //towergroup[i].fireAtTarget(enemygroup[0].sprite);
                            //tower.fireAtClosest();
                            timer = time;
                        }
                    }
                }
            }

        }



    };

    </script>

    </body>
</html>